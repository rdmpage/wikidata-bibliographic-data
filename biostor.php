<?php

// Fetch BioStor article


require_once(dirname(__FILE__) . '/wikidata.php');


$ids = array(
//247844
//217669

//140255,
//140256,

//217651,
//217699,

//247844,

248219,

);

$ids=array(
50031
);

$ids=array(
198779,
198780,
198781,
198782,
198783,
198784,
198785,
198786,
198787,
198788,
198789,
198790,
198791,
198792,
198793,
198794,
198795,
198796,
198797,
198798,
198799,
198800,
198801,
198802,
198803,
198804,
198805,
198806,
198807,
198808,
198809,
198810,
198811,
198812,
198813,
198814,
198815,
198816,
198817,
198818,
198819,
198820,
198821,
198822,
198823,
198824,
198825,
198826,
198827,
198828,
198829,
198830,
198831,
198832,
198833,
198834,
198835,
198836,
198837,
198838,
198839,
198840,
198841,
198842,
198843,
198844,
198845,
198846,
198847,
198848,
198849,
198850,
198851,
198852,
198853,
198854,
198855,
198856,
198857,
198858,
198859,
198860,
198861,
198862,
198863,
198864,
198865,
198866,
198867,
198868,
198869,
198870,
198871,
198872,
198873,
198874,
198875,
198876,
198877,
198878,
198879,
198880,
198881,
198882,
198883,
198884,
198885,
198886,
198887,
198888,
198889,
198890,
198891,
198892,
198893,
198894,
198895,
198896,
198897,
198898,
198899,
198900,
198901,
201375,
201376,
201377,
201378,
201379,
201380,
201381,
201382,
201383,
201384,
204581,
204582,
204583,
204584,
204585,
204586,
204587,
204588,
204589,
204590,
204591,
204592,
204593,
204594,
204595,
204596,
204597,
204628,
204629,
204630,
204631,
204632,
204633,
204634,
204635,
204636,
204637,
204638,
204639,
204640,
204641,
204642,
204643,
204644,
204645,
204646,
204647,
204648,
204649,
204651,
204652,
204653,
204654,
204655,
204656,
204657,
204658,
204659,
204660,
204661,
204662,
204663,
204664,
204665,
204666,
204667,
204668,
214972,
214973,
214974,
214975,
214976,
214977,
214978,
214979,
214980,
214981,
214982,
214983,
214984,
214985,
214986,
214987,
214988,
214989,
214990,
214991,
214992,
214993,
214994,
214995,
214996,
214997,
214998,
214999,
215000,
215001,
215002,
215003,
215004,
215005,
215006,
215007,
215008,
215009,
215010,
215011,
215012,
215013,
215014,
215015,
215016,
215017,
215018,
215019,
215020,
215021,
215022,
215023,
215024,
215025,
215026,
215027,
215028,
215029,
215030,
215031,
215032,
215033,
215034,
215035,
215036,
215037,
215038,
215039,
215040,
215041,
215042,
215043,
215044,
215045,
215046,
215047,
215048,
215049,
215050,
215051,
232214,
232215,
232216,
232217,
232218,
232219,
232220,
232221,
232222,
232223,
232224,
232225,
232226,
232227,
232228,
232229,
232230,
232231,
232232,
232233,
232234,
232235,
232236,
232237,
232238,
232239,
232240,
232241,
232242,
232243,
232244,
232245,
232246,
232247,
232248,
232249,
232250,
232251,
232252,
232253,
232254,
232255,
232256,
232257,
232258,
232259,
232260,
232261,
232262,
232263,
232264,
232265,
232266,
232267,
232268,
232269,
232270,
232271,
232272,
232273,
232274,
232275,
232276,
232277,
232278,
232279,
232280,
232281,
232282,
232283,
232284,
232285,
232286,
232287,
232288,
232289,
232290,
232291,
232292,
232293,
232294,
232295,
232296,
232297,
232298,
232299,
232300,
232301,
232302,
232303,
232304,
232305,
232306,
232307,
232308,
232309,
232310,
232311,
232312,
232313,
232314,
232315,
232316,
232317,
232318,
232319,
232320,
232321,
232322,
232323,
232324,
232325,
232326,
232327,
232328,
232329,
232330,
232331,
232332,
232333,
232334,
232335,
232336,
232337,
232338,
232339,
232340,
232341,
232342,
232343,
232344,
232345,
232346,
232347,
232348,
232349,
232350,
232351,
232352,
232353,
232354,
232355,
232356,
232357,
232358,
232359,
232360,
232361,
232362,
232363,
232364,
232365,
232366,
232367,
232368,
232369,
232370,
232371,
232372,
232373,
232374,
232375,
232376,
232377,
232378,
232379,
232380,
232381,
232382,
232383,
232384,
232385,
232386,
232387,
232388,
232389,
232390,
232391,
232392,
232393,
232394,
232395,
232396,
232397,
232398,
232399,
232400,
232401,
232402,
232403,
232404,
232405,
232406,
232407,
232408,
232409,
232410,
232411,
232412,
232413,
232414,
232415,
232416,
232417,
232418,
232419,
232420,
232421,
232422,
232423,
232424,
232425,
232426,
232427,
232428,
232429,
232430,
232431,
232432,
232433,
232434,
232435,
232436,
232437,
232438,
232439,
232440,
232441,
232442,
232443,
232444,
232445,
232446,
232447,
232448,
232449,
232450,
232451,
232452,
232453,
232454,
232455,
232456,
232457,
232458,
232459,
232460,
232461,
232462,
232463,
232464,
232465,
232466,
232467,
232468,
232469,
232470,
232471,
232472,
232473,
232474,
232475,
232476,
232477,
232478,
232479,
232480,
232481,
232482,
232483,
232484,
232485,
232486,
232487,
232488,
232489,
232490,
232491,
232492,
232493,
232494,
232495,
232496,
232497,
232498,
232499,
261558,
);

$ids=array(
232434,
232435
);

$ids=array(
266423,
266424,
266425,
);

$start = 261433;
$end   = 261460;


$check 					= true;
$update 				= false;
$languages 				= array('en', 'fr', 'de', 'es', 'la');
$always_english_label   = true;

//----------------------------------------------------------------------------------------
function get_part_from_biostor($id)
{
	$config['api_key'] = '0d4f0303-712e-49e0-92c5-2113a5959159';
	
	$part = null;
	
	$parameters = array(
		'op' 	=> 'GetPartByIdentifier',
		'type' 	=> 'biostor',
		'value' => $id,
		'apikey'	=> $config['api_key'],
		'format'	=> 'json'
	);
	
	$url = 'https://www.biodiversitylibrary.org/api2/httpquery.ashx?' . http_build_query($parameters);
	
	//echo $url . "\n";
	
	$json = get($url);
	
	$obj = json_decode($json);
	
	if ($obj && isset($obj->Result))
	{
		if (count($obj->Result) == 1)
		{
			$part = $obj->Result[0];
		}
	}
	
	return $part;
	
}



//----------------------------------------------------------------------------------------

//for ($id = $start; $id <= $end; $id++)

foreach ($ids as $id)
{


	$item = wikidata_item_from_biostor($id);
	
	if ($item != '')
	{
		//echo "Have $id already: $item\n";
	}
	else
	{
		$url = 'http://biostor.org/api.php?id=biostor-' . $id . '&format=citeproc';

		$json = get($url);
		
		if ($json == '') {}
		else
		{
			$csl = json_decode($json);
			
			$csl->BIOSTOR = $id;
			$csl->ARCHIVE = 'biostor-' . $id;
			
			$part = get_part_from_biostor($id);
			if ($part)
			{
				
				$csl->BHLPART = $part->PartID;
				$csl->BHL	  = $part->StartPageID;
				
				$csl->license = array(new stdclass);
				$csl->license[0]->URL = $part->LicenseUrl;
				
				$n1 = count($csl->author);
				$n2 = count($part->Authors);
				
				if ($n1 == $n2)
				{
					for ($i = 0; $i < $n1; $i++)
					{
						if (isset($part->Authors[$i]->CreatorID))
						{
							$csl->author[$i]->BHL = $part->Authors[$i]->CreatorID;
						}					
					}
				}
			}			
						
			//print_r($csl);
			
			//exit();
			
			$work = new stdclass;
			$work->message = $csl;
			
			$source = array();
			$source[] = 'S248';
			$source[] = 'Q18586574'; // BioStor

			$source[] = 'S854';
			$source[] = '"https://biostor.org/reference/' . $id . '"';			
			
			$quickstatements = csljson_to_wikidata($work, 
				$check, 
				$update, 
				$languages,
				$source,
				true
				);
			
			echo $quickstatements . "\n";
		}

	}


}


?>
